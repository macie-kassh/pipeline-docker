version: '2'

services:
  # data container
  databox:
    image: devopsopen/docker-base
    volumes:
      - /data/configdb
      - /data/db
      # for gitlab
      - /etc/gitlab
      - /var/opt/gitlab
      - /var/log/gitlab
      # for Jira
      - /var/atlassian/jira
      - /opt/atlassian/jira/logs

  # database service: mongodb
  mongo:
    image: devopsopen/docker-com-mongo
    ports:
      - "27017:27017"
    volumes_from:
      - databox
    environment:
      - MONGO_MAJOR=3.3
      - MONGO_VERSION=3.3.10
    restart: always

  # source configuration management: gitlab
  cap_scm:
    image: devopsopen/docker-scm-gitlab
    ports:
      - "9010:80"
      - "9443:443"
      - "9022:22"
    volumes_from:
      - databox
    restart: always

  # configuration management: artifactory
  artifactory:
    image: devopsopen/docker-scm-artifactory
    ports:
      - "9011:8081"
    environment:
      - ARTIFACTORY_VERSION=4.9.0
      - ARTIFACTORY_HOME=/opt/artifactory
    restart: always

  # continous assesement : wekan
  cap_ca:
    image: devopsopen/docker-ca-wekan
    ports:
      - "9090:80"
    links:
      - mongo:db
    volumes_from:
      - databox
    environment:
      - MONGO_URL=mongodb://db
      - ROOT_URL=http://127.0.0.1
    restart: always

  # continous assesement : Jira
  jira:
    image: devopsopen/docker-ca-jira
    ports:
      - "9091:8080"
    volumes_from:
      - databox
    environment:
      - JIRA_HOME=/var/atlassian/jira
      - JIRA_INSTALL=/opt/atlassian/jira
      - JIRA_VERSION=7.1.9
    restart: always

  # continous integration : jenkins
  cap_ci:
    image: devopsopen/docker-ci-jenkins
    ports:
      - "9080:8080"
    links:
      - cap_scm
    restart: always

  # continous quality assurance
  cap_cq:
    image: devopsopen/docker-cq-sonarqube
    ports:
      - "9000:9000"
    expose:
      - 9092
    links:
      - cap_scm
      - cap_ci
    restart: always

  # devops pipeline portal
  portal:
    image: devopsopen/docker-pipeline-portal
    ports:
      - "9999:3000"
    restart: always

  # container resource monitor
  cadvisor:
    image: devopsopen/docker-cov-cadvisor
    ports:
      - "9998:8080"
    restart: always

  # hygieia : monitor
  hyapi:
    image: devopsopen/docker-cov-hyapi
    ports:
      - "9888:8080"
    links:
      - mongo:mongo
    environment:
      - SPRING_DATA_MONGODB_HOST=localhost
      - SPRING_DATA_MONGODB_PORT=27017
    restart: always

  hygui:
    image: devopsopen/docker-cov-hygui
    ports:
      - "9088:80"
    links:
      - hyapi:hygieia-api
    environment:
      - SPRING_DATA_MONGODB_HOST=localhost
      - SPRING_DATA_MONGODB_PORT=27017
    restart: always

  hyson:
    image: devopsopen/docker-cov-hyson
    links:
      - mongo:mongo
    environment:
      - SPRING_DATA_MONGODB_HOST=localhost
      - SPRING_DATA_MONGODB_PORT=27017
    restart: always

  hyjen:
    image: devopsopen/docker-cov-hyjen
    links:
      - mongo:mongo
    environment:
      - SPRING_DATA_MONGODB_HOST=localhost
      - SPRING_DATA_MONGODB_PORT=27017
    restart: always

  hysvn:
    image: devopsopen/docker-cov-hysvn
    links:
      - mongo:mongo
    environment:
      - SPRING_DATA_MONGODB_HOST=localhost
      - SPRING_DATA_MONGODB_PORT=27017
    restart: always
